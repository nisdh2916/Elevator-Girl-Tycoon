<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>승강기 운전원 타이쿤</title>
    <style>
        @font-face {
            font-family: 'ChosunIlboMyungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/Chosunilbo_myungjo.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        :root {
            --bg-color: #1a1212;
            --panel-bg: #2d2424;
            --accent-gold: #ffb300;
            --text-color: #e0e0e0;
            --elevator-door: #5d4037;
            --elevator-light: #ffeb3b;
            --danger-color: #ff5252;
            --success-color: #76ff03;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'ChosunIlboMyungjo', serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #game-container {
            display: flex;
            width: 1200px;
            height: 90vh;
            max-height: 800px;
            background: #000;
            border: 4px solid #4e342e;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        /* --- Left: Building Simulation (Visual Only) --- */
        #building-view {
            width: 160px;
            position: relative;
            background: #263238;
            border-right: 4px solid #4e342e;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            /* Floor 1 at bottom */
        }

        .floor {
            position: relative;
            width: 100%;
            height: 50px;
            border-top: 1px solid #37474f;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .floor-label {
            position: absolute;
            left: 5px;
            color: #546e7a;
            font-size: 20px;
        }

        #elevator-shaft {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            width: 40px;
            height: 100%;
            background: #102027;
            border-left: 2px solid #000;
            border-right: 2px solid #000;
            z-index: 10;
            pointer-events: none;
        }

        #elevator-car {
            position: absolute;
            left: 2px;
            bottom: 0;
            width: 32px;
            height: 46px;
            background: var(--elevator-door);
            border: 2px solid #3e2723;
            transition: bottom 0.5s linear;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 12px;
            box-shadow: inset 0 0 5px #000;
        }

        #elevator-car::after {
            content: '';
            position: absolute;
            top: 2px;
            width: 20px;
            height: 10px;
            background: var(--elevator-light);
            opacity: 0.5;
        }

        /* --- Right: Operator Interface --- */
        #control-panel {
            flex: 1;
            background: var(--panel-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4e342e;
            padding-bottom: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            color: var(--accent-gold);
            font-size: 36px;
            text-shadow: 2px 2px 0 #000;
        }

        .wave-info {
            font-size: 24px;
            color: #bcaaa4;
        }

        .score-info {
            font-size: 24px;
            color: var(--success-color);
        }

        /* Passenger Interface Area */
        #passenger-interface {
            flex: 1;
            display: flex;
            gap: 20px;
            min-height: 0;
        }

        .zone {
            flex: 1;
            background: #3e2723;
            border: 2px solid #5d4037;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .zone-header {
            background: #4e342e;
            padding: 10px;
            font-size: 20px;
            color: var(--accent-gold);
            text-align: center;
            border-bottom: 2px solid #5d4037;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .zone-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px;
        }

        /* Passenger Cards */
        .p-card {
            width: 80px;
            height: 100px;
            background: #ffcc80;
            border: 2px solid #e65100;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
            color: #000;
        }

        .p-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .p-card.group-member {
            border-width: 3px;
        }

        .p-dest {
            font-size: 32px;
            font-weight: bold;
        }

        .p-weight {
            font-size: 14px;
            margin-top: 5px;
        }

        .p-group-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        /* Controls Area */
        #controls-area {
            height: 240px;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .control-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .panel-title {
            color: #bcaaa4;
            font-size: 18px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .algo-btn {
            padding: 10px;
            background: #5d4037;
            color: #d7ccc8;
            border: 2px solid #3e2723;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .algo-btn:hover {
            background: #4e342e;
        }

        .algo-btn.active {
            background: var(--accent-gold);
            color: #1a1212;
            border-color: #fff;
        }

        #action-btn {
            padding: 15px;
            font-size: 24px;
            font-family: inherit;
            background: #2e7d32;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 4px 0 #1b5e20;
            margin-top: auto;
        }

        #preview-btn {
            padding: 10px;
            font-size: 18px;
            font-family: inherit;
            background: #0277bd;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 4px 0 #01579b;
            margin-bottom: 10px;
        }

        #action-btn:active,
        #preview-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        #action-btn:disabled,
        #preview-btn:disabled {
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
        }

        #game-log {
            background: #000;
            border: 2px solid #333;
            padding: 10px;
            font-size: 14px;
            color: #00e676;
            font-family: 'Consolas', monospace;
            height: 100%;
            overflow-y: auto;
        }

        /* Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #overlay h2 {
            font-size: 64px;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        #overlay p {
            font-size: 24px;
            max-width: 700px;
            line-height: 1.6;
            margin-bottom: 40px;
        }

        #start-btn {
            padding: 20px 60px;
            font-size: 32px;
            background: var(--accent-gold);
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        /* Game Over / Leaderboard Styles */
        #game-over-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2424;
            border: 4px solid var(--accent-gold);
            padding: 40px;
            text-align: center;
            z-index: 200;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            width: 500px;
        }

        #game-over-modal h2 {
            color: var(--danger-color);
            font-size: 48px;
            margin: 0 0 20px 0;
        }

        #final-score {
            font-size: 36px;
            color: var(--success-color);
            margin-bottom: 30px;
        }

        .initials-input {
            background: #000;
            border: 2px solid #5d4037;
            color: var(--accent-gold);
            font-size: 48px;
            width: 200px;
            text-align: center;
            font-family: inherit;
            letter-spacing: 10px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        #submit-score-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: var(--accent-gold);
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        #leaderboard {
            margin-top: 30px;
            text-align: left;
            border-top: 2px solid #5d4037;
            padding-top: 20px;
        }

        .rank-row {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            margin-bottom: 10px;
            color: #bcaaa4;
        }

        .rank-row.top {
            color: var(--accent-gold);
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1212;
        }

        ::-webkit-scrollbar-thumb {
            background: #5d4037;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <!-- Left: Simulation -->
        <div id="building-view">
            <div id="elevator-shaft">
                <div id="elevator-car"></div>
            </div>
            <!-- Floors generated by JS -->
        </div>

        <!-- Right: Interface -->
        <div id="control-panel">
            <header>
                <h1>승강기 운전원 타이쿤</h1>
                <div class="score-info">점수: <span id="score-display">0</span></div>
                <div class="wave-info">웨이브 <span id="wave-num">1</span>/5</div>
            </header>

            <!-- Passenger Selection Area -->
            <div id="passenger-interface">
                <!-- Platform -->
                <div class="zone" id="platform-zone">
                    <div class="zone-header">
                        <span>대기실 </span>
                        <span id="waiting-count">0</span>
                    </div>
                    <div class="zone-content" id="platform-content">
                        <!-- Passengers go here -->
                    </div>
                </div>

                <!-- Elevator -->
                <div class="zone" id="elevator-zone">
                    <div class="zone-header">
                        <span>승강기(<span id="current-floor-display">1F</span>)</span>
                        <span>
                            <span id="capacity-display">0/8</span> |
                            <span id="weight-display">0/800kg</span>
                        </span>
                    </div>
                    <div class="zone-content" id="elevator-content">
                        <!-- Boarded passengers go here -->
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div id="controls-area">
                <div class="control-col">
                    <div class="panel-title">알고리즘 선택</div>
                    <button class="algo-btn active" data-algo="greedy">탐욕적 기법 (Greedy)</button>
                    <button class="algo-btn" data-algo="divide">분할 정복 (Divide & Conquer)</button>
                    <button class="algo-btn" data-algo="bnb">분기 한정 (Branch & Bound)</button>
                </div>
                <div class="control-col">
                    <div class="panel-title">로그</div>
                    <div id="game-log"></div>
                </div>
                <div class="control-col" style="flex: 0.8;">
                    <button id="preview-btn">경로 미리보기</button>
                    <button id="action-btn">출발</button>
                </div>
            </div>
        </div>
    </div>

    <div id="overlay">
        <h2>승강기 운전원 타이쿤</h2>
        <p>
            <b>운전원 매뉴얼:</b><br><br>
            1. <b>대기실</b>에서 승객을 선택하여 탑승시키세요.<br>
            2. <b>같은 색상의 그룹</b>은 함께 탑승해야 합니다.<br>
            3. <b>정원</b>과 <b>하중</b> 제한을 주의하세요.<br>
            4. 최적의 경로를 위한 <b>알고리즘</b>을 선택하세요.<br>
            5. <b>미리보기</b>를 확인하고 <b>출발</b> 버튼을 누르세요.<br><br>
            <span style="color: var(--success-color); font-size: 0.9em;">
                * <b>점수</b> = (이동 승객 × 500) - (이동 거리 × 10)
            </span><br>
        </p>
        <button id="start-btn">운행 시작</button>
    </div>

    <div id="game-over-modal">
        <h2>GAME OVER</h2>
        <div id="final-score">0점</div>
        <input type="text" class="initials-input" maxlength="3" placeholder="AAA"
            oninput="this.value = this.value.toUpperCase()">
        <br>
        <button id="submit-score-btn">점수 등록</button>

        <div id="leaderboard">
            <!-- Ranks go here -->
        </div>
    </div>

    <script>
        // --- Constants ---
        const FLOORS = 15;
        const MAX_PEOPLE = 8;
        const MAX_WEIGHT = 800;
        const FLOOR_HEIGHT = 50;
        const MAX_WAVES = 5;

        // --- Audio ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const sfx = {
            ding: () => playTone(523.25, 'sine', 0.8),
            move: () => playTone(100, 'sawtooth', 0.1),
            error: () => playTone(150, 'square', 0.3),
            click: () => playTone(800, 'triangle', 0.05),
            board: () => playTone(400, 'sine', 0.1),
            win: () => {
                playTone(523.25, 'square', 0.1);
                setTimeout(() => playTone(659.25, 'square', 0.1), 100);
                setTimeout(() => playTone(783.99, 'square', 0.2), 200);
            }
        };

        // --- State ---
        let currentFloor = 8; // Start in the middle
        let waveCount = 1;
        let isMoving = false;
        let totalScore = 0;
        let waveDistance = 0;

        // Passengers for the current wave
        let passengers = [];

        // --- DOM ---
        const buildingView = document.getElementById('building-view');
        const elevatorCar = document.getElementById('elevator-car');
        const platformContent = document.getElementById('platform-content');
        const elevatorContent = document.getElementById('elevator-content');
        const capacityDisplay = document.getElementById('capacity-display');
        const weightDisplay = document.getElementById('weight-display');
        const logDiv = document.getElementById('game-log');
        const actionBtn = document.getElementById('action-btn');
        const previewBtn = document.getElementById('preview-btn');
        const algoBtns = document.querySelectorAll('.algo-btn');
        const currentFloorDisplay = document.getElementById('current-floor-display');
        const waitingCountDisplay = document.getElementById('waiting-count');
        const scoreDisplay = document.getElementById('score-display');
        const waveNumDisplay = document.getElementById('wave-num');

        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const initialsInput = document.querySelector('.initials-input');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const leaderboardDiv = document.getElementById('leaderboard');

        // --- Init ---
        function initGame() {
            // Reset State
            currentFloor = 8;
            waveCount = 1;
            totalScore = 0;
            isMoving = false;
            scoreDisplay.textContent = 0;

            // Build Floors
            const shaft = document.getElementById('elevator-shaft');
            buildingView.innerHTML = '';
            if (shaft) buildingView.appendChild(shaft);

            for (let i = 1; i <= FLOORS; i++) {
                const f = document.createElement('div');
                f.className = 'floor';
                f.id = `floor-${i}`;

                const label = document.createElement('div');
                label.className = 'floor-label';
                label.textContent = `${i}F`;

                f.appendChild(label);
                buildingView.appendChild(f);
            }

            updateElevatorVisual(currentFloor);
            startWave();
        }

        // --- Wave Logic ---
        function startWave() {
            if (waveCount > MAX_WAVES) {
                endGame();
                return;
            }

            log(`>>> 웨이브 ${waveCount}/${MAX_WAVES} 시작 (현재 ${currentFloor}층) <<<`);
            waveNumDisplay.textContent = waveCount;
            waveDistance = 0; // Reset distance for new wave

            passengers = [];
            const count = Math.floor(Math.random() * 6) + 5; // 5-10 people

            for (let i = 0; i < count; i++) {
                // Group Logic
                const isGroup = Math.random() < 0.3;
                const groupSize = isGroup ? 2 : 1;
                const dest = getRandomFloor(currentFloor);
                const groupId = isGroup ? `g-${Date.now()}-${i}` : null;
                const groupColor = isGroup ? getGroupColor(i) : '#ffcc80';

                for (let g = 0; g < groupSize; g++) {
                    passengers.push({
                        id: `${i}-${g}`,
                        dest: dest,
                        weight: Math.floor(Math.random() * 70) + 60, // 60kg ~ 130kg
                        status: 'waiting', // waiting, boarded, delivered
                        groupId: groupId,
                        color: groupColor
                    });
                }
            }

            renderInterface();
            actionBtn.disabled = false;
            previewBtn.disabled = false;
            actionBtn.textContent = "출발";
            sfx.ding();
        }

        function endGame() {
            sfx.win();
            gameOverModal.style.display = 'block';
            finalScoreDisplay.textContent = `${totalScore}점`;
            initialsInput.value = '';
            initialsInput.focus();
            loadLeaderboard();
        }

        function getRandomFloor(exclude) {
            let f = exclude;
            while (f === exclude) f = Math.floor(Math.random() * FLOORS) + 1;
            return f;
        }

        function getGroupColor(seed) {
            const hues = [0, 60, 120, 180, 240, 300];
            const hue = hues[seed % hues.length];
            return `hsl(${hue}, 70%, 80%)`;
        }

        // --- Rendering ---
        function renderInterface() {
            platformContent.innerHTML = '';
            elevatorContent.innerHTML = '';

            const waiting = passengers.filter(p => p.status === 'waiting');
            const boarded = passengers.filter(p => p.status === 'boarded');

            // Update Stats
            currentFloorDisplay.textContent = `${currentFloor}F`;
            waitingCountDisplay.textContent = waiting.length;
            scoreDisplay.textContent = totalScore;

            const totalWeight = boarded.reduce((sum, p) => sum + p.weight, 0);
            capacityDisplay.textContent = `${boarded.length}/${MAX_PEOPLE}`;
            weightDisplay.textContent = `${totalWeight}/${MAX_WEIGHT}kg`;

            if (totalWeight > MAX_WEIGHT) weightDisplay.style.color = 'var(--danger-color)';
            else weightDisplay.style.color = 'var(--accent-gold)';

            // Render Cards
            waiting.forEach(p => createCard(p, platformContent));
            boarded.forEach(p => createCard(p, elevatorContent));
        }

        function createCard(p, container) {
            const card = document.createElement('div');
            card.className = 'p-card';
            card.style.backgroundColor = p.color;
            if (p.groupId) {
                card.classList.add('group-member');
                card.style.borderColor = adjustColor(p.color, -40);

                const icon = document.createElement('div');
                icon.className = 'p-group-icon';
                icon.style.backgroundColor = p.color;
                card.appendChild(icon);
            }

            const dest = document.createElement('div');
            dest.className = 'p-dest';
            dest.textContent = p.dest;

            const weight = document.createElement('div');
            weight.className = 'p-weight';
            weight.textContent = `${p.weight}kg`;

            card.appendChild(dest);
            card.appendChild(weight);

            card.onclick = () => togglePassenger(p);
            container.appendChild(card);
        }

        function adjustColor(color, amount) {
            return '#000'; // Simplified for now
        }

        // --- Interaction ---
        function togglePassenger(p) {
            if (isMoving) return;

            // Handle Groups
            const targetPassengers = p.groupId
                ? passengers.filter(x => x.groupId === p.groupId)
                : [p];

            // Determine action: Board or Unboard
            const isBoarding = (p.status === 'waiting');

            if (isBoarding) {
                // Check Limits
                const boarded = passengers.filter(x => x.status === 'boarded');
                const currentWeight = boarded.reduce((sum, x) => sum + x.weight, 0);

                const addCount = targetPassengers.length;
                const addWeight = targetPassengers.reduce((sum, x) => sum + x.weight, 0);

                if (boarded.length + addCount > MAX_PEOPLE) {
                    log("정원 초과!"); sfx.error(); return;
                }
                if (currentWeight + addWeight > MAX_WEIGHT) {
                    log("하중 초과!"); sfx.error(); return;
                }

                targetPassengers.forEach(tp => tp.status = 'boarded');
                sfx.board();
            } else {
                // Unboard
                targetPassengers.forEach(tp => tp.status = 'waiting');
                sfx.click();
            }

            renderInterface();
        }

        // --- Algorithms & Movement ---
        function getSelectedAlgo() {
            const active = document.querySelector('.algo-btn.active');
            return active ? active.dataset.algo : 'greedy';
        }

        function solvePath(algo, start, boarded) {
            const destinations = [...new Set(boarded.map(p => p.dest))];
            if (destinations.length === 0) return [];

            if (algo === 'greedy') {
                // Greedy: Nearest Neighbor
                let current = start;
                let remaining = [...destinations];
                const path = [];
                while (remaining.length > 0) {
                    remaining.sort((a, b) => Math.abs(a - current) - Math.abs(b - current));
                    const next = remaining.shift();
                    path.push(next);
                    current = next;
                }
                return path;

            } else if (algo === 'divide') {
                // Divide & Conquer
                const sorted = [...destinations].sort((a, b) => a - b);
                const lower = sorted.filter(x => x < start).sort((a, b) => b - a);
                const upper = sorted.filter(x => x > start).sort((a, b) => a - b);
                if (Math.abs(start - (lower[0] || 999)) < Math.abs(start - (upper[0] || 999))) {
                    return [...lower, ...upper];
                } else {
                    return [...upper, ...lower];
                }

            } else if (algo === 'bnb') {
                // Branch & Bound (Optimal Path)
                // Uses simple recursion with pruning to find min distance path
                let bestPath = null;
                let minCost = Infinity;

                function search(currentFloor, visited, currentPath, currentCost) {
                    // Pruning
                    if (currentCost >= minCost) return;

                    if (visited.length === destinations.length) {
                        if (currentCost < minCost) {
                            minCost = currentCost;
                            bestPath = [...currentPath];
                        }
                        return;
                    }

                    // Simple heuristic: remaining nodes count * min edge (optional, but keeping it simple)
                    // Try all unvisited nodes
                    for (const dest of destinations) {
                        if (!visited.includes(dest)) {
                            const dist = Math.abs(dest - currentFloor);
                            search(dest, [...visited, dest], [...currentPath, dest], currentCost + dist);
                        }
                    }
                }

                search(start, [], [], 0);
                return bestPath;

            }

            return [];
        }

        // --- Preview Logic ---
        function showPreview() {
            if (isMoving) return;
            const boarded = passengers.filter(p => p.status === 'boarded');
            if (boarded.length === 0) {
                log("탑승한 승객이 없습니다.");
                return;
            }
            const algo = getSelectedAlgo();
            const path = solvePath(algo, currentFloor, boarded);
            log(`[미리보기] ${algo.toUpperCase()}: ${currentFloor} -> ${path.join(' -> ')}`);
        }

        previewBtn.addEventListener('click', showPreview);

        actionBtn.addEventListener('click', () => {
            if (isMoving) return;
            const boarded = passengers.filter(p => p.status === 'boarded');
            if (boarded.length === 0) {
                log("탑승한 승객이 없습니다!"); sfx.error(); return;
            }

            isMoving = true;
            actionBtn.disabled = true;
            previewBtn.disabled = true;
            actionBtn.textContent = "운행 중...";

            const algo = getSelectedAlgo();
            const path = solvePath(algo, currentFloor, boarded);

            log(`알고리즘: ${algo.toUpperCase()} | 경로: ${currentFloor} -> ${path.join(' -> ')}`);
            animateElevator(path);
        });

        async function animateElevator(path) {
            for (const dest of path) {
                sfx.move();
                await moveElevatorTo(dest);
                sfx.ding();
                log(`${dest}층 도착.`);

                // Deliver passengers
                const leaving = passengers.filter(p => p.status === 'boarded' && p.dest === dest);
                leaving.forEach(p => p.status = 'delivered');

                renderInterface();
                await sleep(600);
            }

            // --- Score Calculation ---
            const deliveredCount = passengers.filter(p => p.status === 'delivered').length;
            const waveScore = (deliveredCount * 500) - (waveDistance * 10);
            totalScore += waveScore;
            scoreDisplay.textContent = totalScore;

            // Rank Calculation
            let rank = 'C';
            const efficiency = deliveredCount > 0 ? waveScore / deliveredCount : 0;
            if (efficiency >= 450) rank = 'S';
            else if (efficiency >= 400) rank = 'A';
            else if (efficiency >= 300) rank = 'B';

            log(`[평가] 점수: ${waveScore}점 | 거리: ${waveDistance}층`);

            log("운행 완료. 대기 위치로 이동합니다...");
            await sleep(500);

            // Return to middle floor (5-10)
            const restFloor = Math.floor(Math.random() * 6) + 5; // 5 to 10
            await moveElevatorTo(restFloor);
            log(`대기 위치(${restFloor}층) 도착.`);

            isMoving = false;
            waveCount++;
            setTimeout(startWave, 1000);
        }

        function moveElevatorTo(target) {
            return new Promise(resolve => {
                const dist = Math.abs(target - currentFloor);
                waveDistance += dist; // Track distance for score

                const duration = dist * 400;

                elevatorCar.style.transition = `bottom ${duration}ms linear`;
                elevatorCar.style.bottom = `${(target - 1) * FLOOR_HEIGHT}px`;

                currentFloor = target;
                setTimeout(resolve, duration);
            });
        }

        function updateElevatorVisual(floor) {
            elevatorCar.style.bottom = `${(floor - 1) * FLOOR_HEIGHT}px`;
        }

        function log(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        algoBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (isMoving) return;
                algoBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sfx.click();
            });
        });

        // --- Leaderboard Logic ---
        function loadLeaderboard() {
            const scores = JSON.parse(localStorage.getItem('elevator_scores') || '[]');
            leaderboardDiv.innerHTML = '';

            scores.slice(0, 5).forEach((s, i) => {
                const row = document.createElement('div');
                row.className = `rank-row ${i === 0 ? 'top' : ''}`;
                row.innerHTML = `<span>${i + 1}. ${s.name}</span> <span>${s.score}</span>`;
                leaderboardDiv.appendChild(row);
            });
        }

        submitScoreBtn.addEventListener('click', () => {
            const name = initialsInput.value.toUpperCase();
            if (name.length < 3) {
                alert("이니셜 3글자를 입력해주세요!");
                return;
            }

            const scores = JSON.parse(localStorage.getItem('elevator_scores') || '[]');
            scores.push({ name: name, score: totalScore });
            scores.sort((a, b) => b.score - a.score);
            localStorage.setItem('elevator_scores', JSON.stringify(scores));

            loadLeaderboard();
            submitScoreBtn.disabled = true;
            initialsInput.disabled = true;

            // Add Restart Button
            const restartBtn = document.createElement('button');
            restartBtn.textContent = "다시 하기";
            restartBtn.style.marginTop = "20px";
            restartBtn.style.padding = "10px 20px";
            restartBtn.style.fontSize = "20px";
            restartBtn.style.background = "#2e7d32";
            restartBtn.style.color = "#fff";
            restartBtn.style.border = "none";
            restartBtn.style.cursor = "pointer";
            restartBtn.onclick = () => location.reload();
            gameOverModal.appendChild(restartBtn);
        });

        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            initGame();
        });

    </script>
</body>

</html>